name: dev-deploy-v2

on:
  workflow_dispatch:
    inputs:
      aws_region:
        description: "AWS region"
        required: false
        default: "ap-northeast-1"
        type: string
      image_tag:
        description: "Backend image tag to deploy to dev"
        required: false
        default: "manual"
        type: string

permissions:
  id-token: write
  contents: read

concurrency:
  group: dev-deploy-v2
  cancel-in-progress: false

jobs:
  deploy:
    runs-on: ubuntu-latest
    env:
      AWS_REGION: ${{ inputs.aws_region || vars.AWS_REGION }}
      AWS_ROLE_TO_ASSUME: ${{ vars.AWS_ROLE_TO_ASSUME_DEV_DEPLOY }}
      TF_STATE_BUCKET: ${{ vars.TF_STATE_BUCKET }}
      ROOT_DOMAIN: ${{ vars.ROOT_DOMAIN }}
      API_DOMAIN: ${{ vars.DEV_API_DOMAIN }}
      RUN_APPLY: "true"
      APPLY_APPROVE_TOKEN: "apply-dev"
      RUN_HEALTH_CHECK: "true"
      CREATE_DNS_RECORDS: "true"

    steps:
      - name: Guard apply branch
        if: ${{ env.RUN_APPLY == 'true' && github.ref_name != 'dev' }}
        run: |
          echo "[ERROR] run_apply=true is allowed only on dev branch."
          echo "current ref: ${{ github.ref_name }}"
          exit 1

      - name: Guard apply approval token
        if: ${{ env.RUN_APPLY == 'true' && env.APPLY_APPROVE_TOKEN != 'apply-dev' }}
        run: |
          echo "[ERROR] run_apply=true requires apply_approve_token=apply-dev."
          exit 1

      - name: Guard required variables
        run: |
          set -euo pipefail
          for v in AWS_REGION AWS_ROLE_TO_ASSUME TF_STATE_BUCKET ROOT_DOMAIN; do
            if [ -z "${!v:-}" ]; then
              echo "[ERROR] missing required variable: $v"
              exit 1
            fi
          done

      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.6.6

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ env.AWS_ROLE_TO_ASSUME }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Terraform init (dev)
        run: |
          terraform -chdir=infra/terraform/envs/dev init -reconfigure \
            -backend-config="bucket=${{ env.TF_STATE_BUCKET }}" \
            -backend-config="key=enm/dev/terraform.tfstate" \
            -backend-config="region=${{ env.AWS_REGION }}" \
            -backend-config="use_lockfile=true" \
            -backend-config="encrypt=true" \
            -input=false

      - name: Terraform plan (dev)
        run: |
          terraform -chdir=infra/terraform/envs/dev plan \
            -input=false \
            -out=tfplan \
            -var "root_domain=${{ env.ROOT_DOMAIN }}" \
            -var "shared_state_bucket=${{ env.TF_STATE_BUCKET }}" \
            -var "shared_state_key=enm/shared/terraform.tfstate" \
            -var "shared_state_region=${{ env.AWS_REGION }}" \
            -var "runtime_enabled=true" \
            -var "create_dns_records=${{ env.CREATE_DNS_RECORDS }}" \
            -var "api_image_tag=${{ inputs.image_tag }}"

      - name: Terraform apply (dev)
        if: ${{ env.RUN_APPLY == 'true' }}
        run: terraform -chdir=infra/terraform/envs/dev apply -input=false -auto-approve tfplan

      - name: Wait for ECS service stable
        if: ${{ env.RUN_APPLY == 'true' && env.RUN_HEALTH_CHECK == 'true' }}
        run: |
          aws ecs wait services-stable \
            --cluster "enm-dev-cluster" \
            --services "enm-dev-api" \
            --region "${{ env.AWS_REGION }}"

      - name: Health check (ALB and API domain)
        if: ${{ env.RUN_APPLY == 'true' && env.RUN_HEALTH_CHECK == 'true' }}
        env:
          API_DOMAIN: ${{ env.API_DOMAIN }}
          AWS_REGION: ${{ env.AWS_REGION }}
        shell: bash
        run: |
          set -euo pipefail

          ALB_DNS="$(terraform -chdir=infra/terraform/envs/dev output -raw alb_dns_name)"
          if [ -z "$ALB_DNS" ]; then
            echo "[ERROR] alb_dns_name is empty."
            exit 1
          fi

          check_with_retry() {
            local name="$1"
            local url="$2"
            local attempts=20
            local sleep_sec=15

            for ((i=1; i<=attempts; i++)); do
              echo "[$name] attempt $i/$attempts: $url"
              if body="$(curl -fsS --max-time 20 "$url")"; then
                echo "$body"
                if [[ "$body" == *'"status":"ok"'* ]]; then
                  echo "[OK] $name"
                  return 0
                fi
              fi
              sleep "$sleep_sec"
            done

            echo "[ERROR] $name health check failed: $url"
            return 1
          }

          check_with_retry "ALB" "http://${ALB_DNS}/health"
          check_with_retry "API-Domain" "http://${API_DOMAIN}/health"

      - name: Show ECS recent events on failure
        if: failure()
        run: |
          aws ecs describe-services \
            --cluster "enm-dev-cluster" \
            --services "enm-dev-api" \
            --region "${{ env.AWS_REGION }}" \
            --query "services[0].events[0:15].[createdAt,message]" \
            --output table || true

      - name: Summary
        if: always()
        run: |
          echo "image_tag: ${{ inputs.image_tag }}"
          echo "run_apply: ${{ env.RUN_APPLY }}"
          echo "run_health_check: ${{ env.RUN_HEALTH_CHECK }}"

      - name: Notify Discord (success)
        if: ${{ success() && secrets.DEV_DEPLOY_DISCORD_WEBHOOK != '' }}
        env:
          DISCORD_WEBHOOK: ${{ secrets.DEV_DEPLOY_DISCORD_WEBHOOK }}
        shell: bash
        run: |
          set -euo pipefail
          RUN_URL="https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          MSG="[SUCCESS] dev-deploy success
repository: ${{ github.repository }}
branch: ${{ github.ref_name }}
image_tag: ${{ inputs.image_tag }}
run: ${RUN_URL}"

          jq -n --arg content "$MSG" '{content: $content}' | \
            curl -fsS -X POST -H "Content-Type: application/json" --data @- "$DISCORD_WEBHOOK"

      - name: Notify Discord (failure)
        if: ${{ failure() && secrets.DEV_DEPLOY_DISCORD_WEBHOOK != '' }}
        env:
          DISCORD_WEBHOOK: ${{ secrets.DEV_DEPLOY_DISCORD_WEBHOOK }}
        shell: bash
        run: |
          set -euo pipefail
          RUN_URL="https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          MSG="[FAILED] dev-deploy failed
repository: ${{ github.repository }}
branch: ${{ github.ref_name }}
image_tag: ${{ inputs.image_tag }}
run: ${RUN_URL}"

          jq -n --arg content "$MSG" '{content: $content}' | \
            curl -fsS -X POST -H "Content-Type: application/json" --data @- "$DISCORD_WEBHOOK"

