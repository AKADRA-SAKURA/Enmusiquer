name: dev-deploy

on:
  workflow_dispatch:
    inputs:
      aws_region:
        description: "AWS region"
        required: true
        default: "ap-northeast-1"
        type: string
      aws_role_to_assume:
        description: "IAM role ARN for GitHub OIDC (Terraform apply)"
        required: true
        type: string
      tf_state_bucket:
        description: "Terraform state bucket for dev/shared"
        required: true
        type: string
      root_domain:
        description: "Root domain (for example: enmusiquer.com)"
        required: true
        type: string
      image_tag:
        description: "Backend image tag to deploy to dev"
        required: true
        type: string
      create_dns_records:
        description: "Create Route53 records in dev"
        required: true
        default: true
        type: boolean
      run_apply:
        description: "Run terraform apply"
        required: true
        default: true
        type: boolean
      run_health_check:
        description: "Run health check after apply"
        required: true
        default: true
        type: boolean
      api_domain:
        description: "API domain for health check"
        required: true
        default: "api-dev.enmusiquer.com"
        type: string
      ecs_cluster_name:
        description: "ECS cluster name for dev"
        required: true
        default: "enm-dev-cluster"
        type: string
      ecs_service_name:
        description: "ECS service name for dev"
        required: true
        default: "enm-dev-api"
        type: string

permissions:
  id-token: write
  contents: read

concurrency:
  group: dev-deploy
  cancel-in-progress: false

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.6.6

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ inputs.aws_role_to_assume }}
          aws-region: ${{ inputs.aws_region }}

      - name: Terraform init (dev)
        run: |
          terraform -chdir=infra/terraform/envs/dev init -reconfigure \
            -backend-config="bucket=${{ inputs.tf_state_bucket }}" \
            -backend-config="key=enm/dev/terraform.tfstate" \
            -backend-config="region=${{ inputs.aws_region }}" \
            -backend-config="use_lockfile=true" \
            -backend-config="encrypt=true" \
            -input=false

      - name: Terraform plan (dev)
        run: |
          terraform -chdir=infra/terraform/envs/dev plan \
            -input=false \
            -out=tfplan \
            -var "root_domain=${{ inputs.root_domain }}" \
            -var "shared_state_bucket=${{ inputs.tf_state_bucket }}" \
            -var "shared_state_key=enm/shared/terraform.tfstate" \
            -var "shared_state_region=${{ inputs.aws_region }}" \
            -var "runtime_enabled=true" \
            -var "create_dns_records=${{ inputs.create_dns_records }}" \
            -var "api_image_tag=${{ inputs.image_tag }}"

      - name: Terraform apply (dev)
        if: ${{ inputs.run_apply }}
        run: terraform -chdir=infra/terraform/envs/dev apply -input=false -auto-approve tfplan

      - name: Wait for ECS service stable
        if: ${{ inputs.run_apply && inputs.run_health_check }}
        run: |
          aws ecs wait services-stable \
            --cluster "${{ inputs.ecs_cluster_name }}" \
            --services "${{ inputs.ecs_service_name }}" \
            --region "${{ inputs.aws_region }}"

      - name: Health check (ALB and API domain)
        if: ${{ inputs.run_apply && inputs.run_health_check }}
        env:
          API_DOMAIN: ${{ inputs.api_domain }}
          AWS_REGION: ${{ inputs.aws_region }}
        shell: bash
        run: |
          set -euo pipefail

          ALB_DNS="$(terraform -chdir=infra/terraform/envs/dev output -raw alb_dns_name)"
          if [ -z "$ALB_DNS" ]; then
            echo "[ERROR] alb_dns_name is empty."
            exit 1
          fi

          check_with_retry() {
            local name="$1"
            local url="$2"
            local attempts=20
            local sleep_sec=15

            for ((i=1; i<=attempts; i++)); do
              echo "[$name] attempt $i/$attempts: $url"
              if body="$(curl -fsS --max-time 20 "$url")"; then
                echo "$body"
                if [[ "$body" == *'"status":"ok"'* ]]; then
                  echo "[OK] $name"
                  return 0
                fi
              fi
              sleep "$sleep_sec"
            done

            echo "[ERROR] $name health check failed: $url"
            return 1
          }

          check_with_retry "ALB" "http://${ALB_DNS}/health"
          check_with_retry "API-Domain" "http://${API_DOMAIN}/health"

      - name: Show ECS recent events on failure
        if: failure()
        run: |
          aws ecs describe-services \
            --cluster "${{ inputs.ecs_cluster_name }}" \
            --services "${{ inputs.ecs_service_name }}" \
            --region "${{ inputs.aws_region }}" \
            --query "services[0].events[0:15].[createdAt,message]" \
            --output table || true

      - name: Summary
        if: always()
        run: |
          echo "image_tag: ${{ inputs.image_tag }}"
          echo "run_apply: ${{ inputs.run_apply }}"
          echo "run_health_check: ${{ inputs.run_health_check }}"
