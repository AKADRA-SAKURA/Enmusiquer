name: terraform-secret-guard

on:
  pull_request:
  push:
    branches:
      - main

jobs:
  guard:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Block tracked secret files
        shell: bash
        run: |
          set -euo pipefail

          tracked_files="$(git ls-files)"
          forbidden="$(echo "$tracked_files" | grep -E '^infra/terraform/.*\.tfstate(\..*)?$|^infra/terraform/.*/terraform\.tfvars$|^infra/terraform/.*\.auto\.tfvars$|^infra/terraform/.*\.tfvars\.json$|^infra/terraform/envs/.*/backend\.hcl$' || true)"
          if [ -n "$forbidden" ]; then
            echo "[ERROR] Forbidden Terraform secret files are tracked:"
            echo "$forbidden"
            exit 1
          fi

      - name: Ensure backend.hcl examples are safe
        shell: bash
        run: |
          set -euo pipefail

          files=(
            "infra/terraform/envs/shared/backend.hcl.example"
            "infra/terraform/envs/dev/backend.hcl.example"
            "infra/terraform/envs/prod/backend.hcl.example"
          )

          for file in "${files[@]}"; do
            if [ ! -f "$file" ]; then
              echo "[ERROR] Missing file: $file"
              exit 1
            fi

            if ! grep -q 'REPLACE_ME_TFSTATE_BUCKET' "$file"; then
              echo "[ERROR] backend.hcl.example must keep placeholder bucket in repository: $file"
              exit 1
            fi
          done

      - name: Scan tracked files for known secret patterns
        shell: bash
        run: |
          set -euo pipefail

          if git grep -n -I -E 'https?://discord(app)?\.com/api/webhooks/[A-Za-z0-9_/-]+' -- . ':(exclude)*.example'; then
            echo "[ERROR] Found Discord webhook URL in repository files."
            exit 1
          fi

          if git grep -n -I -E 'AKIA[0-9A-Z]{16}|aws_secret_access_key\s*=\s*"' -- . ':(exclude)*.example'; then
            echo "[ERROR] Found AWS credential pattern in repository files."
            exit 1
          fi
