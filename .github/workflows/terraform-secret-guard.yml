name: terraform-secret-guard

on:
  pull_request:
    paths:
      - "infra/terraform/**"
      - ".github/workflows/terraform-secret-guard.yml"
  push:
    branches:
      - main
    paths:
      - "infra/terraform/**"
      - ".github/workflows/terraform-secret-guard.yml"

jobs:
  guard:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Block tracked secret files
        shell: bash
        run: |
          set -euo pipefail

          tracked_files="$(git ls-files)"
          forbidden="$(echo "$tracked_files" | grep -E '^infra/terraform/.*\.tfstate(\..*)?$|^infra/terraform/.*/terraform\.tfvars$|^infra/terraform/.*\.auto\.tfvars$|^infra/terraform/.*\.tfvars\.json$' || true)"
          if [ -n "$forbidden" ]; then
            echo "[ERROR] Forbidden Terraform secret files are tracked:"
            echo "$forbidden"
            exit 1
          fi

      - name: Ensure backend.hcl placeholders are safe
        shell: bash
        run: |
          set -euo pipefail

          files=(
            "infra/terraform/envs/shared/backend.hcl"
            "infra/terraform/envs/dev/backend.hcl"
            "infra/terraform/envs/prod/backend.hcl"
          )

          for file in "${files[@]}"; do
            if [ ! -f "$file" ]; then
              echo "[ERROR] Missing file: $file"
              exit 1
            fi

            if ! grep -q 'REPLACE_ME_TFSTATE_BUCKET' "$file"; then
              echo "[ERROR] backend.hcl must keep placeholder bucket in repository: $file"
              exit 1
            fi
          done

      - name: Scan Terraform files for known secret patterns
        shell: bash
        run: |
          set -euo pipefail

          if grep -R -n -E 'discord_webhook_url\s*=\s*"https?://discord(app)?\.com/api/webhooks/' infra/terraform --exclude='*.example'; then
            echo "[ERROR] Found Discord webhook URL in repository files."
            exit 1
          fi

          if grep -R -n -E 'AKIA[0-9A-Z]{16}|aws_secret_access_key\s*=\s*"' infra/terraform --exclude='*.example'; then
            echo "[ERROR] Found AWS credential pattern in repository files."
            exit 1
          fi