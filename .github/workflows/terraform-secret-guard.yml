name: terraform-secret-guard

on:
  pull_request:
  push:
    branches:
      - main

jobs:
  guard:
    runs-on: ubuntu-latest

    steps:
      - name: チェックアウト
        uses: actions/checkout@v4

      - name: 機密ファイルの追跡を禁止
        shell: bash
        run: |
          set -euo pipefail

          tracked_files="$(git ls-files)"
          forbidden="$(echo "$tracked_files" | grep -E '^infra/terraform/.*\.tfstate(\..*)?$|^infra/terraform/.*/terraform\.tfvars$|^infra/terraform/.*\.auto\.tfvars$|^infra/terraform/.*\.tfvars\.json$|^infra/terraform/envs/.*/backend\.hcl$' || true)"
          if [ -n "$forbidden" ]; then
            echo "[エラー] 追跡禁止の Terraform 機密ファイルが Git 管理されています:"
            echo "$forbidden"
            exit 1
          fi

      - name: backend.hcl.example の安全性チェック
        shell: bash
        run: |
          set -euo pipefail

          files=(
            "infra/terraform/envs/shared/backend.hcl.example"
            "infra/terraform/envs/dev/backend.hcl.example"
            "infra/terraform/envs/prod/backend.hcl.example"
          )

          for file in "${files[@]}"; do
            if [ ! -f "$file" ]; then
              echo "[エラー] 必須ファイルが見つかりません: $file"
              exit 1
            fi

            if ! grep -q 'REPLACE_ME_TFSTATE_BUCKET' "$file"; then
              echo "[エラー] backend.hcl.example にはプレースホルダバケットを残してください: $file"
              exit 1
            fi
          done

      - name: 既知の機密パターンをスキャン
        shell: bash
        run: |
          set -euo pipefail

          if git grep -n -I -E 'https?://discord(app)?\.com/api/webhooks/[A-Za-z0-9_/-]+' -- . ':(exclude)*.example'; then
            echo "[エラー] リポジトリ内に Discord Webhook URL が見つかりました。"
            exit 1
          fi

          if git grep -n -I -E 'AKIA[0-9A-Z]{16}|aws_secret_access_key\s*=\s*"' -- . ':(exclude)*.example'; then
            echo "[エラー] リポジトリ内に AWS 認証情報パターンが見つかりました。"
            exit 1
          fi
