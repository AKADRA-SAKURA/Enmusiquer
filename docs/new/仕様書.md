# Enmusiquer リニューアル仕様書（MVP）

作成日: 2026-02-11  
対象: `docs/old/*` と `docs/new/20260211草案.md` を統合した新仕様  
方針: 新仕様（草案）を優先しつつ、旧仕様から再利用可能な要素を引き継ぐ

---

## 1. 目的

Enmusiquer を、旧 Rails 製 Web サービスから FastAPI ベースの新アーキテクチャへ移行し、  
「タグを軸に、短時間で好みの曲に出会える体験」を提供する。

MVP では以下を最重視する。

- 曲との出会い（発見）
- タグを使った探索
- 投稿のしやすさ（URL 貼り付け中心）

---

## 2. プロダクト定義

### 2.1 コンセプト

- 曲そのものより「印象・構成・シーン」タグで探せる
- 好みタグや Like/Skip をもとに、おすすめを提示する
- UGC 型だが、ライト層でも扱いやすい UI を目指す

### 2.2 想定ユーザー

- 音楽好きの一般ユーザー（ライト層を含む）
- 年齢層は 10 代から 50 代以上まで広く想定

### 2.3 主な利用シーン

- 通勤/通学などの短時間
- 休憩時間などのスキマ時間

---

## 3. スコープ

### 3.1 MVP 対象

- 新着一覧
- 人気/ランキング
- タグ検索
- 曲詳細
- 曲投稿（追加）
- マイページ（好みタグ/保存）
- あとで聴く保存
- 通知一覧
- ルールベース AI レコメンド

### 3.2 MVP で後回し

- コメント
- ユーザーフォロー
- DM
- プレイリスト
- アプリ内埋め込み再生

---

## 4. 技術方針

### 4.1 構成

- monorepo 構成
- `frontend/`, `backend/`, `infra/`, `docs/` を単一リポジトリで管理

### 4.2 バックエンド

- FastAPI
- PostgreSQL
- SQLAlchemy
- Alembic

### 4.3 フロントエンド

- 初期リリースは iOS / Android ストア配布を前提
- 実装技術は別途確定

### 4.4 インフラ

- AWS 前提（詳細は別設計）

---

## 5. 機能要件

### 5.1 曲投稿

- URL 貼り付けで曲を追加できる
- 対応サービス: YouTube / Spotify / Apple Music / SoundCloud
- URL から曲名・アーティスト・サムネイル等を自動補完する
- 自動補完後に手動修正できる
- 同一曲判定は URL ベースで行う（ID 優先判定は採用しない）
- 投稿時に重複候補がある場合、既存曲を提示して統合を促す

旧仕様からの引き継ぎ:

- 作詞/作曲/年/使用作品などの補助情報入力
- 画像登録（サムネイル未取得時の補完用途）

### 5.2 タグ

- タグは候補選択 + 自由入力の両対応
- タグは曲に複数付与できる
- 表記ゆれは初期許容し、後から同義語統合する
- 同義語統合は「自動候補提示 + 管理者承認」で実施する
- 統合作業は AKADRA が月1回実施する

旧仕様からの引き継ぎ:

- 曲とタグの中間テーブル設計（多対多）
- 複数タグ AND 検索

### 5.3 検索/発見

- キーワード検索（曲名、アーティスト名、補助情報）
- タグ検索（単一）
- 複数タグ絞り込み（AND）
- 新着表示
- 人気/ランキング表示（反応数ベース）

旧仕様からの引き継ぎ:

- 旧検索導線（キーワード検索 + タグ絞り込み）
- 旧ランキング機能（Like 集計）

### 5.4 好み判定/レコメンド

- 入力要素: 好きなタグのフォロー、Like/Skip、初回診断
- 算出方式: 「タグ一致率 80%」+「全体アクセス数 20%」のシンプルスコア
- 表示順: 総合スコア順
- 複雑な ML は MVP 対象外

### 5.5 アカウント/認証

- 閲覧はログイン不要
- 投稿・保存はログイン必須
- ログイン方式:
  - 優先: Google
  - サブ: X / メール

### 5.6 SNS 共有

- X 向けにテンプレ文章を生成して共有できる

### 5.7 モデレーション

- 通報機能
- NG ワード
- 管理者による削除
- 通報発生時は AKADRA の Discord へ通知する

### 5.8 通知

- ユーザー向け通知は「好みタグ一致の新着曲」のみ通知する
- ユーザー向け通知は日次まとめで毎日 20:00 に配信する
- 運用通知（エラー/障害）は Discord へ通知する

### 5.9 課金機能の有効化方針

- 開発中は課金を開始しない（リリース開始日まで無料運用）
- サーバー側で `billing_enabled` フラグを判定し、`false` の間は課金処理を実行しない
- 開発期間は決済プロバイダの test mode のみ利用する
- 課金UIを表示する場合でも、`billing_enabled=false` 時は購入実行をブロックする
- リリース日に `billing_enabled=true` へ切り替えて課金を開始する
- 課金開始フラグの変更は監査ログに記録する（変更者/変更時刻）

---

## 6. データ要件（MVP）

### 6.1 主要エンティティ

- `users`
- `tracks`（旧 `tweets` 相当）
- `tags`
- `track_tags`（旧 `tag_relations` 相当）
- `user_track_preferences`（Like/Skip）
- `bookmarks`（あとで聴く）
- `notifications`

備考:

- `comments` は旧仕様に存在するが、MVP は対象外
- 旧 `genres` は利用実績が薄いため、MVP では必須にしない

### 6.2 tracks の主項目

- 基本: `title`, `artist_display_name`, `thumbnail_url`
- URL 系: `source_url`, `source_type`, `source_track_id`
- 任意メタ: `writer`, `composer`, `year`, `record_info`, `usage_context`
- アーティスト補助: `series_name`, `album_artist_name`
- 監査: `created_by`, `created_at`, `updated_at`

### 6.3 制約方針

- `track_tags`: `(track_id, tag_id)` 一意
- `user_track_preferences`: `(user_id, track_id)` 一意
- `tracks`: 正規化済み `source_url` に一意制約を設定し、URL ベースで重複検知する
- FK を全テーブルで明示し、旧仕様の参照不整合を解消する

---

## 7. 旧仕様からの移行方針

### 7.1 移行対象

- 既存データは `seeds.rb` 由来データを移行対象とする
- 移行対象:
  - 曲
  - タグ
  - 曲-タグ紐付け
  - Like（新 `user_track_preferences` の `like` に変換）

### 7.2 マッピング方針

- `tweets.title` -> `tracks.title`
- `tweets.artist` -> `tracks.artist_display_name`
- `tweets.movieurl/published/online` -> `tracks.source_url`
  - URL 候補が複数ある場合は `movieurl` 優先、次に `published`、最後に `online`
- `tags.tag` -> `tags.name`
- `tag_relations` -> `track_tags`
- `likes` -> `user_track_preferences(reaction='like')`

### 7.3 クリーニング

- タグ前後の空白除去（旧データに `" 3音サビ"` のような揺れあり）
- 重複タグの統合ルール適用
- URL 正規化（ドメイン統一、追跡パラメータ除去、末尾スラッシュ統一）

### 7.4 管理権限

- 既存データは AKADRA アカウントで管理可能とする

---

## 8. API 方針（FastAPI）

MVP はアプリ向け JSON API を提供する。  
旧 Rails の HTML レンダリング中心構成は引き継がない。

詳細契約は `docs/new/API契約.md` を正本とする。

想定エンドポイント（概要）:

- `GET /v1/tracks`
- `GET /v1/tracks/{track_id}`
- `POST /v1/tracks`
- `GET /v1/tags`
- `GET /v1/search/tracks`
- `POST /v1/search/tracks/by-tags`
- `POST /v1/tracks/{track_id}/preference`（like/skip）
- `POST /v1/tracks/{track_id}/bookmark`
- `GET /v1/recommendations`
- `GET /v1/rankings`
- `GET /v1/system/billing-status`
- `PATCH /v1/admin/billing-settings`

---

## 9. 認可・セキュリティ方針

- 旧仕様で課題だった「Controller 側の所有者チェック不足」を解消する
- 編集/削除は投稿者本人または管理者のみ許可する
- 反応系 API は認証必須に統一する
- 不正入力対策:
  - URL バリデーション
  - NG ワードチェック
  - レート制限（投稿/通報）

---

## 10. 非機能要件（MVP）

- 可用性: 一般的な Web サービス水準
- 性能: 一覧 API はページング前提
- ログ: 監査ログ（投稿、削除、モデレーション操作）
- 運用: Alembic でスキーマ変更履歴を管理
- 品質: 単体テスト + API テストを最低限整備
- 監視: 障害/例外アラートは Discord 通知を最低ラインとする

---

## 11. 未確定事項

- フロントエンド技術スタック
- AWS 詳細パラメータ（CIDR/スケーリング閾値/バックアップ保持日数）
- Push 通知の実装方式（FCM/APNs連携方式）
- 管理画面の詳細範囲
- AI レコメンド高度化の実施時期

---

## 12. 採否整理（旧仕様との差分）

### 12.1 引き継ぐもの

- 曲/タグ/Like を中心としたドメイン
- キーワード検索 + タグ検索 + 複数タグ絞り込み
- ランキング導線
- ログイン不要閲覧、ログイン必須投稿の基本方針

### 12.2 変更するもの

- Rails の HTML レンダリング中心 -> FastAPI の API 中心
- `Tweet` 命名 -> `Track` 命名へ統一
- 旧ルーティング不整合（未実装 action 参照）を解消
- DB 制約を強化（FK/UNIQUE の明確化）

### 12.3 MVP から外すもの

- コメント
- フォロー
- DM
- プレイリスト

---

## 13. AWS運用方針（確定）

### 13.1 アカウント/環境

- AWSアカウントは単一（1アカウント）で運用する
- 運用環境は `dev` / `prod` の2環境を用意する
- 2環境は同一アカウント内で分離する（命名規則・タグ・IAM・ネットワークで分離）

### 13.2 IaC / デプロイ

- インフラ定義は Terraform で管理する
- デプロイは GitHub Actions で自動化する

### 13.3 実行基盤 / データ基盤

- FastAPI は ECS Fargate で運用する
- DB は RDS PostgreSQL Single-AZ（MVP）で開始する
- バックアップは PITR + 日次バックアップを有効化する

### 13.4 認証 / 配信

- 認証基盤は Cognito 中心で構築する（Google優先、X/メールは段階対応）
- 静的配信は S3 + CloudFront を使用する
- 境界防御は CloudFront + WAF + ALB 構成とする

### 13.5 監視 / 通知 / コスト

- 監視は CloudWatch + Alarm + Discord 通知を最低ラインとする
- コスト管理は AWS Budgets + 異常検知を有効化する

### 13.6 命名規則

- `dev` 環境: `enm-dev-*`
- `prod` 環境: `enm-prod-*`

### 13.7 Terraform state 分離

- Terraform state は backend 分離で管理する
- 同一S3バケットを使う場合でも `dev/prod` で `key` を分ける
- `terraform workspace` のみでの分離は採用しない

### 13.8 リソース分離方針（dev/prod）

- 方針: 実行系は分離、土台は共有
- 環境ごとに分離するリソース:
  - ECS（Service/Task）
  - RDS
  - ALB
  - WAF
  - CloudFront
  - Secrets Manager / SSM Parameter
  - アプリ用S3バケット
  - CloudWatch Alarm
- 共有するリソース:
  - VPC（MVP期間）
  - ECR
  - Route53 Hosted Zone
  - Terraform backend用S3/DynamoDB

### 13.9 Terraform ディレクトリ構成（推奨）

```text
infra/
  terraform/
    modules/
      network_shared/
      ecr_shared/
      route53_shared/
      ecs_service/
      rds_postgres/
      alb/
      waf/
      cloudfront/
      app_s3/
      monitoring/
      cognito_auth/

    envs/
      shared/
        backend.hcl
        main.tf
        variables.tf
        terraform.tfvars
        outputs.tf
      dev/
        backend.hcl
        main.tf
        variables.tf
        terraform.tfvars
        outputs.tf
      prod/
        backend.hcl
        main.tf
        variables.tf
        terraform.tfvars
        outputs.tf
```

- `modules/*`: 再利用可能な部品のみを配置する
- `envs/shared`: 共有基盤（VPC, ECR, Route53 など）を管理する
- `envs/dev`: `dev` 実行系を管理する
- `envs/prod`: `prod` 実行系を管理する
- `backend.hcl` は環境ごとに分ける
- Terraform state key 例:
  - `shared`: `enm/shared/terraform.tfstate`
  - `dev`: `enm/dev/terraform.tfstate`
  - `prod`: `enm/prod/terraform.tfstate`

---

## 14. フロントデザイン要件（追加）

- デザインテーマは「赤・オレンジ基調の今どき音楽プレイヤー」。
- 視覚トーンは 熱量 / 夜のライブ感 / スピード感 を重視する。
- UI はカードベースで、余白を活かしたモダン構成にする。

### 14.1 カラー方針

- プライマリ: #FF4D2D（レッドオレンジ）
- セカンダリ: #FF8A1F（オレンジ）
- アクセント: #FFD166（ハイライト）
- 背景: ダークネイビー〜ブラック系グラデーション
- 文字色: 本文は高コントラストの明色、補助情報は彩度を落とした明色

### 14.2 画面表現

- 主要画面（ホーム/再生/発見）で「Now Playing」領域をファーストビューに配置。
- ジャケット、再生コントロール、進捗バー、タグ、保存アクションを同一ビューで扱えるようにする。
- 推薦曲リストは「タグ一致」と「人気」を視認しやすいラベルで表示する。

### 14.3 モーション

- 初回表示でフェード + スライドの軽い導入アニメーションを使用する。
- 再生中はミニマルなイコライザー表現を表示し、状態を視覚化する。
- アニメーションは 150ms〜350ms 程度の短時間を基本とし、過剰演出を避ける。

### 14.4 アクセシビリティ

- 文字コントラストは WCAG AA 相当を満たす。
- タップ領域はモバイルで最低 44px を確保する。
- 色以外でも状態判別できるよう、アイコン/ラベルを併用する。

### 14.5 実装メモ（MVP）

- 初期実装は Web でデザインを固め、後続で iOS/Android へ展開する。
- デザイントークン（色、角丸、影、余白、タイポグラフィ）を共通変数化する。
---

## 15. コンテナデプロイ運用（MVP）

- バックエンドは Docker イメージ化し、ECR（`enm/backend`）へ push して運用する。
- ECS で利用するイメージタグは Terraform 変数 `api_image_tag` で切り替える。
- デプロイ順序は `shared -> dev -> prod` を基本とし、`prod` は明示承認トークン付きで apply する。
- apply 前に secret guard と plan を必ず実施する。