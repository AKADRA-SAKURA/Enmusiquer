# Enmusiquer 編集履歴

最終更新: 2026-02-12

## 2026-02-12

- `d8f40e2` 1st commit
  - プロジェクト初期構成を追加。

- `be682d8` 課金フラグ運用のAPI設計固定
  - リリース時に課金開始へ切り替えるための方針を整理。

- `ab862a4` API本体テスト拡充SQLite互換修正
  - APIテストを拡充。
  - SQLite互換性まわりを修正。

- `8e4bdd4` feat(backend)APIレスポンス契約の明確化、CIテスト自動化、DB型方針注記を追加
  - `response_model` を明示してAPI契約を明確化。
  - GitHub Actionsでbackendテストの自動実行を追加。
  - AlembicにDB型運用方針の注記を追加。

- `6bbd298` feat(terraform): shared基盤(VPC/ECR/Route53)実装とdev/prodのshared state参照を追加
  - `shared` 環境にVPC/ECR/Route53の実体定義を追加。
  - `dev/prod` から `terraform_remote_state` で `shared` を参照可能に変更。

- `b413774` feat(terraform): ALB/ECS/RDSを実装しruntime_enabledで課金前ON/OFF可能にする
  - `runtime_enabled` で実行系リソース(ALB/ECS/RDS)の作成を切替可能に変更。
  - 課金開始前は `runtime_enabled=false` で運用できる構成に更新。

## 2026-02-12（未コミット作業）

- `cloudfront` / `waf` / `monitoring` モジュールの実体化を実施。
  - CloudFront: S3オリジン + OAC + Distribution + バケットポリシー。
  - WAF: Managed Rules + Rate Limit + ALB関連付け。
  - Monitoring: ECS/ALB/RDS向けCloudWatchアラーム。
- `dev/prod` の `variables.tf` / `main.tf` / `outputs.tf` / `terraform.tfvars.example` を更新。
  - `edge_enabled` / `monitoring_enabled` など段階有効化フラグを追加。
- `Route53` 連携を追加。
  - `create_dns_records` で API/CDN のAレコード(エイリアス)を自動作成可能に変更。
  - `api_record_name` / `cdn_record_name` でサブドメイン名を環境別に設定可能。
- Terraform 設定の安定化。
  - `count`/`for_each` の未知値起因で `plan` が詰まりやすい箇所を整理。
- ECR運用の改善。
  - `shared` の ECR にライフサイクルポリシーを追加（保持件数を変数化）。
  - `dev/prod` の ECS イメージを `shared` の `backend` リポジトリ + `api_image_tag` で指定可能に変更。
- Terraform CI追加。
  - `terraform-validate` workflow を追加。
  - `fmt -check` と `envs/shared/dev/prod` の `validate` を自動実行。
- ECS実行設定の拡張。
  - `api_environment_variables` / `api_secret_arns` を追加し、コンテナへ環境変数・Secrets注入に対応。
  - `runtime_enabled=true` 時に `DB_HOST` / `DB_MASTER_SECRET_ARN` を自動注入。
- ドキュメント整備。
  - `infra/terraform/README.md` を日本語化し、運用手順・フラグ説明を整理。
- Terraform不具合修正。
  - `route53_shared` の `existing_hosted_zone_id` バリデーションで `trim()` 誤用を修正（`trimspace()` へ変更）。
- Terraform backend更新。
  - `backend.hcl` のロック設定を `dynamodb_table` から `use_lockfile=true` へ変更し、非推奨警告を解消。
  - README の前提条件と backend 設定説明を新方式に更新。
- Discord通知連携を追加。
  - `discord_alerting` モジュール（SNS + Lambda + Discord Webhook）を追加。
  - `monitoring_alarm_actions` が空の場合に Discord 通知用SNSを自動採用するよう `dev/prod` を更新。

## 運用ルール

- 作業完了ごとに、日付・コミットID・実施内容を本ファイルへ追記する。
- コミット前の作業は「未コミット作業」欄に記載し、コミット後に正式履歴へ移動する。

- フロント要件追加（赤・オレンジ基調の今どき音楽プレイヤー）
  - docs/new/仕様書.md にデザイン要件（カラー/画面表現/モーション/アクセシビリティ）を追記。
- フロント最小モックを新規作成
  - rontend/index.html / rontend/styles.css / rontend/app.js / rontend/README.md を追加。