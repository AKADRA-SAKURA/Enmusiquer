# DB仕様

対象スキーマ: `db/schema.rb`（version: `2020_08_21_073924`）

## テーブル一覧

- `users`
- `tweets`
- `tags`
- `tag_relations`
- `likes`
- `comments`
- `genres`

根拠:
- `db/schema.rb:15`
- `db/schema.rb:25`
- `db/schema.rb:31`
- `db/schema.rb:40`
- `db/schema.rb:49`
- `db/schema.rb:56`
- `db/schema.rb:73`

## 主キー（PK）

Rails標準により全テーブル `id`（bigint）をPKとして持つ前提。  
（`create_table` 時に `id: false` 指定なし）

根拠:
- `db/schema.rb` の各 `create_table` 定義に `id: false` がない

## テーブル仕様（主要列）

### users

- 主要列
  - `email` string, `null: false`, default `""`
  - `encrypted_password` string, `null: false`, default `""`
  - `reset_password_token` string
  - `reset_password_sent_at` datetime
  - `remember_created_at` datetime
  - `user_name` string
  - `icon_url` string
- INDEX
  - unique: `email`
  - unique: `reset_password_token`

根拠:
- `db/schema.rb:74`
- `db/schema.rb:75`
- `db/schema.rb:81`
- `db/schema.rb:82`
- `db/schema.rb:83`
- `db/schema.rb:84`

### tweets

- 主要列
  - `title` string
  - `artist` string
  - `writer` string
  - `composer` string
  - `published` text
  - `record` text
  - `online` text
  - `user_id` integer
  - `image` string
  - `used` text
  - `year` integer
  - `movieurl` text
- INDEX
  - スキーマ上の明示indexなし

根拠:
- `db/schema.rb:59`
- `db/schema.rb:66`
- `db/schema.rb:68`
- `db/schema.rb:71`

### tags

- 主要列
  - `tag` string
  - `user_id` integer
- INDEX
  - スキーマ上の明示indexなし

根拠:
- `db/schema.rb:52`
- `db/schema.rb:53`

### tag_relations

- 主要列
  - `tweet_id` bigint, `null: false`
  - `tag_id` bigint, `null: false`
- INDEX
  - `index_tag_relations_on_tweet_id`
  - `index_tag_relations_on_tag_id`
- FK
  - `tweet_id -> tweets.id`
  - `tag_id -> tags.id`

根拠:
- `db/schema.rb:41`
- `db/schema.rb:42`
- `db/schema.rb:45`
- `db/schema.rb:46`
- `db/schema.rb:91`
- `db/schema.rb:92`

### likes

- 主要列
  - `tweet_id` bigint, `null: false`
  - `user_id` bigint, `null: false`
- INDEX
  - `index_likes_on_tweet_id`
  - `index_likes_on_user_id`
- FK
  - `tweet_id -> tweets.id`
  - `user_id -> users.id`

根拠:
- `db/schema.rb:32`
- `db/schema.rb:33`
- `db/schema.rb:36`
- `db/schema.rb:37`
- `db/schema.rb:89`
- `db/schema.rb:90`

### comments

- 主要列
  - `comment` string
  - `user_id` bigint, `null: false`
  - `tweet_id` bigint, `null: false`
- INDEX
  - `index_comments_on_user_id`
  - `index_comments_on_tweet_id`
- FK
  - `user_id -> users.id`
  - `tweet_id -> tweets.id`

根拠:
- `db/schema.rb:16`
- `db/schema.rb:17`
- `db/schema.rb:18`
- `db/schema.rb:21`
- `db/schema.rb:22`
- `db/schema.rb:87`
- `db/schema.rb:88`

### genres

- 主要列
  - `genre` string
- 使用状況
  - モデルはあるが、Controller/Viewからの主要利用は未確認

根拠:
- `db/schema.rb:28`
- `app/models/genre.rb:1`

## 外部キー一覧

- `comments.tweet_id -> tweets.id`
- `comments.user_id -> users.id`
- `likes.tweet_id -> tweets.id`
- `likes.user_id -> users.id`
- `tag_relations.tag_id -> tags.id`
- `tag_relations.tweet_id -> tweets.id`

根拠:
- `db/schema.rb:87`
- `db/schema.rb:88`
- `db/schema.rb:89`
- `db/schema.rb:90`
- `db/schema.rb:91`
- `db/schema.rb:92`

## 主な制約

- DBレベル
  - `users.email` UNIQUE
  - `users.reset_password_token` UNIQUE
  - `comments.user_id`, `comments.tweet_id` NOT NULL
  - `likes.user_id`, `likes.tweet_id` NOT NULL
  - `tag_relations.user_id` は存在せず、`tweet_id`/`tag_id` が NOT NULL
- アプリレベル
  - `likes` は `tweet_id + user_id` 重複禁止（モデルバリデーション）
  - Deviseによるメール/パスワード制約

根拠:
- `db/schema.rb:83`
- `db/schema.rb:84`
- `db/schema.rb:17`
- `db/schema.rb:18`
- `db/schema.rb:32`
- `db/schema.rb:33`
- `db/schema.rb:41`
- `db/schema.rb:42`
- `app/models/like.rb:4`
- `config/initializers/devise.rb:181`

## インデックス推測（実装クエリに基づく）

現状の検索/集計クエリから、移行後に検討すべきインデックスです。

1. `tweets` のキーワード検索対象列
- 推測: `title`, `artist`, `used`, `composer`, `writer`, `record`, `published`, `online` へのLIKE ORはフルスキャンになりやすい。
- 候補: RDBに応じた全文検索インデックス（MySQLならFULLTEXT、PostgreSQLならGIN+tsvector等）。
- 根拠: `app/controllers/search_controller.rb:5`

2. `tags.tag`（タグ名検索）
- 推測: `Tag.where("tag LIKE ...")` 用に `tags(tag)` インデックスが有効。
- 根拠: `app/controllers/tags_controller.rb:6`

3. `likes(tweet_id, user_id)` 複合UNIQUE
- 推測: 競合時重複防止をDBで担保するため複合UNIQUE化が望ましい。
- 根拠: `app/models/like.rb:4`, `db/schema.rb:36`, `db/schema.rb:37`

4. `tag_relations(tweet_id, tag_id)` 複合UNIQUE
- 推測: 同じタグを同じ曲へ重複付与することを防ぐ用途。
- 根拠: `db/schema.rb:45`, `db/schema.rb:46`

5. `tweets.user_id`, `tags.user_id` の参照整合
- 推測: ユーザー別一覧頻度と参照整合性を考えると、FK + indexが妥当。
- 根拠: `db/schema.rb:66`, `db/schema.rb:53`, `app/controllers/users_controller.rb:4`

## モデル定義との不整合（移行時注意）

1. `TagRelation` の `optional: true` と DB `null: false` の矛盾
- 根拠: `app/models/tag_relation.rb:2`, `db/schema.rb:41`

2. `User` の `has_many :tag`（単数）
- 根拠: `app/models/user.rb:9`

3. `Tag` の `has_many :tweet`（単数）と `scope :from_tag` の未定義 `TweetTag` 参照
- 根拠: `app/models/tag.rb:3`, `app/models/tag.rb:6`

4. `tags.user_id`, `tweets.user_id` がDB外部キー未設定
- 根拠: `db/schema.rb:53`, `db/schema.rb:66`, `db/schema.rb:87`

