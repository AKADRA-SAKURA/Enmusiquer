# Enmusiquer 仕様書（移行用）

最終更新: 2026-02-10  
対象: `e:\01_VSCode\Enmusiquer-Legacy`

## 1. 概要（何ができるサイト/アプリか）

Enmusiquer は、楽曲情報を投稿・閲覧し、タグ/いいね/コメントで発見や共有を行うWebアプリです。  
主なユースケースは以下です。

- 楽曲を投稿する（タイトル、アーティスト、作詞/作曲、年、公開情報、使用作品、画像、YouTube URL）
- 楽曲にタグを付けて分類する
- キーワード検索と複数タグ絞り込みで楽曲を探す
- いいね数によるランキングを見る
- 楽曲にコメントする
- ユーザーごとの投稿一覧/いいね一覧を見る

根拠:
- `config/routes.rb:7`
- `app/controllers/tweets_controller.rb:4`
- `app/controllers/search_controller.rb:3`
- `app/controllers/tweets_controller.rb:14`
- `app/views/tweets/show.html.erb:98`
- `app/views/users/show.html.erb:24`

## 2. 用語・概念（曲、タグ、ユーザー、好み、等）

- 曲（Tweet）: 楽曲エントリ。投稿者（`user_id`）を持つ。  
  根拠: `db/schema.rb:56`, `app/models/tweet.rb:2`
- タグ（Tag）: 楽曲分類ラベル。作成者（`user_id`）を持つ。  
  根拠: `db/schema.rb:49`, `db/schema.rb:53`, `app/models/tag.rb:4`
- タグ付け（TagRelation）: 曲とタグの中間テーブル。  
  根拠: `db/schema.rb:40`, `app/models/tag_relation.rb:2`
- ユーザー（User）: Devise認証ユーザー。メール/パスワードで認証。  
  根拠: `config/routes.rb:2`, `app/models/user.rb:15`
- いいね（Like）: ユーザーが曲を好意評価する行為。1ユーザー1曲に対して重複禁止（モデルバリデーション）。  
  根拠: `app/models/like.rb:4`
- コメント（Comment）: 曲に対するテキストコメント。  
  根拠: `app/models/comment.rb:3`, `app/controllers/comments_controller.rb:20`
- 好み（推測）: 明示的な好み判定ロジックはなく、「いいね」とタグ絞り込みが実質的な好み表現。  
  根拠: `app/controllers/likes_controller.rb:2`, `app/controllers/search_controller.rb:11`

## 3. 画面一覧と画面遷移（主要画面の目的/入力/出力）

| 画面 | ルート | 目的 | 主入力 | 主出力 | 主遷移 |
|---|---|---|---|---|---|
| トップ | `GET /` | 最新投稿3件とランキング3件表示 | なし | 楽曲カード、いいねUI | 楽曲詳細、ランキング、一覧 |
| 楽曲一覧 | `GET /tweets` | 全楽曲一覧（20件/ページ） | ページ番号 | 楽曲カード一覧 | 楽曲詳細、アーティスト別 |
| 楽曲投稿 | `GET /tweets/new` | 新規投稿 | 各楽曲項目、画像 | 投稿作成 | 作成後に編集画面へ |
| 楽曲編集 | `GET /tweets/:id/edit` | 投稿編集・タグ選択 | 楽曲項目、タグ複数選択 | 更新結果 | 更新後に詳細へ |
| 楽曲詳細 | `GET /tweets/:id` | 楽曲詳細/いいね/コメント | コメント投稿、いいね操作 | 詳細情報、YouTube埋め込み | 編集、削除、タグ別 |
| ランキング | `GET /tweets/ranking` | いいね数上位3件表示 | なし | 順位付き一覧 | 楽曲詳細 |
| アーティスト別 | `GET /tweets/artist.:id` | 同一アーティスト曲一覧 | `format`に楽曲ID | アーティスト一致一覧 | 楽曲詳細 |
| タグ一覧 | `GET /tags/index` | タグ一覧、タグ名検索 | タグ名キーワード | タグ一覧 | タグ詳細、タグ作成 |
| タグ詳細 | `GET /tags/search.:id` | 指定タグに紐づく曲一覧 | `format`にタグID | 楽曲一覧 | 楽曲詳細 |
| 詳細検索 | `GET /search/search` | 曲情報の全文LIKE検索 | キーワード | 該当楽曲一覧 | 楽曲詳細 |
| 複数タグ検索 | `GET /search/tagsearch` | AND条件のタグ絞り込み | 複数タグID | 該当楽曲一覧 | 楽曲詳細 |
| マイページ | `GET /users/:id` | 自投稿一覧、いいね済み一覧 | ページ番号 | 2種類の一覧 | 楽曲編集/削除 |
| ログイン/登録 | Devise標準 | 認証 | メール、パスワード等 | セッション作成/ユーザー作成 | トップ/マイページ |

根拠:
- `config/routes.rb:7`
- `config/routes.rb:12`
- `config/routes.rb:13`
- `config/routes.rb:24`
- `config/routes.rb:27`
- `config/routes.rb:14`
- `config/routes.rb:15`
- `config/routes.rb:17`
- `config/routes.rb:18`
- `config/routes.rb:20`
- `config/routes.rb:21`
- `config/routes.rb:29`
- `app/controllers/hello_controller.rb:4`
- `app/controllers/tweets_controller.rb:5`
- `app/controllers/tweets_controller.rb:27`
- `app/views/tweets/edit.html.erb:30`
- `app/views/search/tagsearch.html.erb:6`

補足:
- `tweets/artist` と `tags/search` はREST風IDパスではなく `format` パラメータ利用です。  
  根拠: `app/controllers/tweets_controller.rb:9`, `app/controllers/tags_controller.rb:17`

## 4. 機能一覧（投稿、検索、タグ付け、好み判定など）

- 投稿機能
  - 楽曲作成: ログイン必須。作成時に `movieurl` 末尾11文字を保存。
  - 楽曲更新/削除: 実装上はログイン必須だが、所有者チェックはControllerに未実装（View側のみ）。
  - 根拠: `app/controllers/tweets_controller.rb:2`, `app/controllers/tweets_controller.rb:26`, `app/controllers/tweets_controller.rb:58`, `app/views/tweets/show.html.erb:5`
- タグ機能
  - タグ作成/削除: ログイン必須。
  - 楽曲へのタグ付け: 楽曲編集画面で複数チェック。
  - 根拠: `app/controllers/tags_controller.rb:2`, `app/views/tweets/edit.html.erb:30`
- 検索機能
  - キーワード検索: title/artist/used/composer/writer/record/published/online のLIKE OR。
  - 複数タグ検索: TagRelation経由でAND一致。
  - 根拠: `app/controllers/search_controller.rb:5`, `app/controllers/search_controller.rb:33`, `app/controllers/search_controller.rb:39`
- いいね機能
  - 作成/削除あり。重複はモデルバリデーションで防止。
  - 根拠: `app/controllers/likes_controller.rb:2`, `app/controllers/likes_controller.rb:7`, `app/models/like.rb:4`
- コメント機能
  - 楽曲詳細で投稿、一覧表示。
  - 根拠: `app/controllers/comments_controller.rb:4`, `app/views/tweets/show.html.erb:98`
- ランキング
  - Like件数集計の上位3曲表示。
  - 根拠: `app/controllers/tweets_controller.rb:14`, `app/controllers/hello_controller.rb:5`
- ユーザープロフィール
  - 自投稿一覧、いいね済み曲一覧、アイコン/表示名編集（Devise編集画面）。
  - 根拠: `app/views/users/show.html.erb:24`, `app/views/users/show.html.erb:60`, `app/views/users/show.html.erb:8`

## 5. API相当の挙動（RailsのControllerごとに、入力/処理/出力の要約）

詳細は `document/02_API相当挙動.md` を参照。  
要点:

- すべてHTMLサーバーレンダリング + リダイレクト型（JSON APIは未実装）
- Controller単位で認証要件が不統一（`LikesController`/`UsersController` に `authenticate_user!` 不在）
- ルーティング定義と実装アクションに不一致あり（`hello#about`、`tweets#search`）

根拠:
- `config/routes.rb:10`
- `config/routes.rb:46`
- `app/controllers/hello_controller.rb:3`
- `app/controllers/tweets_controller.rb:2`
- `app/controllers/likes_controller.rb:2`

## 6. DB仕様（テーブル一覧、主キー、外部キー、主な制約、インデックス推測）

詳細は `document/03_DB仕様.md` を参照。  
要点:

- 主テーブル: `users`, `tweets`, `tags`, `tag_relations`, `likes`, `comments`, `genres`
- FKは `comments/likes/tag_relations` のみ（`tweets.user_id`, `tags.user_id` はFKなし）
- UNIQUEは `users.email`, `users.reset_password_token` のみ
- Like重複禁止はDB制約でなくモデルバリデーションのみ

根拠:
- `db/schema.rb:83`
- `db/schema.rb:84`
- `db/schema.rb:87`
- `db/schema.rb:53`
- `db/schema.rb:66`
- `app/models/like.rb:4`

## 7. 権限・認証（ログイン要否、権限の差）

- 認証基盤: Devise（`User`）
  - 根拠: `config/routes.rb:2`, `app/models/user.rb:15`
- ログイン必須
  - `TweetsController` の `new/create/edit/update/destroy`
  - `TagsController` の `new/create/destroy`
  - `CommentsController#create`
  - 根拠: `app/controllers/tweets_controller.rb:2`, `app/controllers/tags_controller.rb:2`, `app/controllers/comments_controller.rb:2`
- 非ログイン閲覧可
  - トップ、楽曲一覧/詳細、ランキング、アーティスト別、タグ一覧/検索、詳細検索
  - 根拠: `app/controllers/tweets_controller.rb:2`, `app/controllers/tags_controller.rb:2`, `config/routes.rb:7`
- 権限制御の弱点
  - 投稿の編集/削除はViewでのみ所有者判定し、Controllerで所有者チェック未実装。
  - `LikesController` に認証フィルタがなく、未ログイン直接アクセスで例外化リスク。
  - 根拠: `app/views/tweets/show.html.erb:5`, `app/controllers/tweets_controller.rb:49`, `app/controllers/likes_controller.rb:2`

## 8. 非機能（バリデーション、例外、ログ、管理機能、モデレーション）

- バリデーション
  - Devise標準（email形式、password長など）
  - Likeの一意性（`tweet_id` + `user_id`）
  - それ以外の業務入力バリデーションはほぼ未実装
  - 根拠: `config/initializers/devise.rb:181`, `config/initializers/devise.rb:186`, `app/models/like.rb:4`
- 例外/エラー処理
  - 多くが失敗時 `redirect_to` のみ。`rescue_from` 等は未実装。
  - 根拠: `app/controllers/tweets_controller.rb:31`, `app/controllers/tags_controller.rb:31`
- ログ
  - パスワードのフィルタリングあり。
  - 本番ログレベル `debug`。
  - 根拠: `config/initializers/filter_parameter_logging.rb:4`, `config/environments/production.rb:51`
- ストレージ
  - 画像は開発/テストでローカル、productionでCloudinary CarrierWave。
  - 根拠: `app/uploaders/image_uploader.rb:7`, `app/uploaders/image_uploader.rb:13`
- 管理機能/モデレーション
  - 専用の管理者ロールやモデレーション機能は未確認（実質なし）。
  - 根拠: `app/controllers` 一覧と `config/routes.rb` に管理用ルートなし
- テスト品質
  - テストファイルは雛形のみで実質未整備。
  - 根拠: `test/controllers/tweets_controller_test.rb:1`, `test/models/tweet_test.rb:1`

## 9. 既知の曖昧点（コードから断定できない点、仮説、確認方法）

1. `hello/about` が動作するか不明
- 観測: ルートはあるが `HelloController` に `about` メソッドがない。
- 仮説: 実装漏れで `ActionNotFound` の可能性。
- 根拠: `config/routes.rb:10`, `app/controllers/hello_controller.rb:3`
- 確認方法: `GET /hello/about` を実行しステータス/例外確認。

2. `tags/:tag_id/tweets` が動作するか不明
- 観測: ルートは `tweets#search` だが `TweetsController` に `search` 未定義。
- 仮説: 未使用の死んだルート。
- 根拠: `config/routes.rb:46`, `app/controllers/tweets_controller.rb:4`
- 確認方法: `rails routes` と `GET /tags/:id/tweets` 実行。

3. ユーザー名入力が登録/編集で正しく保存されるか不明
- 観測: 新規登録フォームが `:username` を送信、DB/許可属性は `user_name`。編集画面も `user_name` が `email_field`。
- 仮説: `user_name` が期待どおり保存されないケースがある。
- 根拠: `app/views/users/registrations/new.html.erb:13`, `app/controllers/application_controller.rb:11`, `db/schema.rb:81`, `app/views/users/registrations/edit.html.erb:8`
- 確認方法: サインアップ/編集を実行して `users.user_name` を確認。

4. いいねAPIの未ログインアクセス挙動が不明
- 観測: `LikesController` に `authenticate_user!` がない。
- 仮説: 未ログインPOSTで500系例外の可能性。
- 根拠: `app/controllers/likes_controller.rb:2`
- 確認方法: 未ログインで `POST /tweets/:id/likes` を叩く。

5. タグ詳細画面の一部動作が不整合
- 観測: `already_liked?` に `TagRelation` を渡している、編集リンクIDが `tweet.id` でなく `tag_relation.id`。
- 仮説: いいね状態判定や編集遷移が誤動作する。
- 根拠: `app/views/tags/search.html.erb:19`, `app/views/tags/search.html.erb:29`
- 確認方法: タグ詳細画面からいいね/編集を操作し遷移先と結果を確認。

6. `Tag`/`User` の関連定義が意図どおりか不明
- 観測: `has_many :tag`, `has_many :tweet`（単数）や未定義 `TweetTag` を参照するスコープがある。
- 仮説: 古い実装残骸で未使用、または将来実装途中。
- 根拠: `app/models/user.rb:9`, `app/models/tag.rb:3`, `app/models/tag.rb:6`
- 確認方法: `rails console` で関連参照とスコープ実行可否を検証。

7. モデルとDB制約の不整合
- 観測: `TagRelation` は `optional: true` だがDBは `null: false`。
- 仮説: アプリ層/DB層で制約方針が分裂している。
- 根拠: `app/models/tag_relation.rb:2`, `db/schema.rb:41`, `db/schema.rb:42`
- 確認方法: `TagRelation.new(tag: nil, tweet: nil).valid?` と保存時例外確認。

8. 「好み判定」機能の定義
- 観測: 推薦アルゴリズムやスコアリング処理は未確認。`Like` とタグ絞り込みのみ確認。
- 仮説（推測）: 本アプリでの「好み」は明示的いいね/タグ選択のこと。
- 根拠: `app/controllers/likes_controller.rb:2`, `app/controllers/search_controller.rb:11`
- 確認方法: 要件元資料（企画書/仕様原本）と照合。

